# Fixing Gauge NoClassDefFoundError

## The Problem

Gauge can find your compiled test classes, but it can't find the Spring Boot JAR dependencies (Spring Framework, Hibernate, etc.). That's why you get `NoClassDefFoundError`.

## Root Cause

When Gauge runs, it needs:
1. âœ… Your compiled `.class` files (ProfileApiSteps, etc.)
2. âŒ All the JAR dependencies (spring-boot, spring-web, etc.)

The second part is missing from Gauge's classpath!

## The Solution

We need to:
1. Copy all Gradle dependencies to a folder
2. Tell Gauge where to find them

## Quick Fix

```bash
# Make script executable
chmod +x fix-gauge-noclassdef.sh

# Run it
./fix-gauge-noclassdef.sh

# Test
gauge run specs
```

## Manual Fix (If you prefer)

### Step 1: Update build.gradle

Replace your `build.gradle` with the one from outputs. Key addition:

```gradle
// This task copies all dependencies to libs/gauge/
tasks.register('copyGaugeDependencies', Copy) {
    from configurations.testRuntimeClasspath
    into 'libs/gauge'
}

// Gauge task depends on this
tasks.register('gaugeTest', Exec) {
    dependsOn testClasses, copyGaugeDependencies
    // ...
}
```

### Step 2: Update env/default/java.properties

Replace with the one from outputs:

```properties
gauge_custom_build_path = build/classes/java/main:build/classes/java/test:build/resources/main:build/resources/test
gauge_additional_libs = libs/gauge/*  # â† Points to our copied JARs
```

### Step 3: Copy Dependencies

```bash
./gradlew copyGaugeDependencies
```

This will copy ~150 JAR files to `libs/gauge/`:
- spring-boot-3.2.0.jar
- spring-web-6.1.1.jar
- jackson-databind-2.15.3.jar
- hibernate-core-6.3.1.Final.jar
- etc.

### Step 4: Verify

```bash
# Check JARs were copied
ls -la libs/gauge/ | head -20

# Should see files like:
# spring-boot-3.2.0.jar
# spring-web-6.1.1.jar
# etc.
```

### Step 5: Test

```bash
# Direct
gauge run specs

# Or via Gradle
./gradlew gaugeTest
```

## How It Works

### Before (Broken):
```
Gauge runs
  â†“
Finds ProfileApiSteps.class âœ…
  â†“
Tries to load Spring Boot classes âŒ
  â†’ NoClassDefFoundError!
```

### After (Fixed):
```
Gauge runs
  â†“
Loads from gauge_custom_build_path:
  - ProfileApiSteps.class âœ…
  â†“
Loads from gauge_additional_libs:
  - spring-boot-3.2.0.jar âœ…
  - spring-web-6.1.1.jar âœ…
  - All other dependencies âœ…
  â†“
Everything works! ğŸ‰
```

## What Gets Copied

The `copyGaugeDependencies` task copies ALL your `testRuntimeClasspath` dependencies:

```
libs/gauge/
â”œâ”€â”€ spring-boot-3.2.0.jar
â”œâ”€â”€ spring-boot-autoconfigure-3.2.0.jar
â”œâ”€â”€ spring-boot-starter-3.2.0.jar
â”œâ”€â”€ spring-boot-starter-web-3.2.0.jar
â”œâ”€â”€ spring-boot-starter-data-jpa-3.2.0.jar
â”œâ”€â”€ spring-boot-starter-security-3.2.0.jar
â”œâ”€â”€ spring-web-6.1.1.jar
â”œâ”€â”€ spring-webmvc-6.1.1.jar
â”œâ”€â”€ spring-data-jpa-3.2.0.jar
â”œâ”€â”€ hibernate-core-6.3.1.Final.jar
â”œâ”€â”€ postgresql-42.7.1.jar
â”œâ”€â”€ jackson-databind-2.15.3.jar
â”œâ”€â”€ lombok-1.18.30.jar
â”œâ”€â”€ ... (150+ JARs total)
```

## Troubleshooting

### Still getting NoClassDefFoundError?

```bash
# 1. Ensure JARs were copied
ls libs/gauge/*.jar | wc -l
# Should show ~150 files

# 2. Check java.properties
cat env/default/java.properties
# Should have: gauge_additional_libs = libs/gauge/*

# 3. Re-copy dependencies
rm -rf libs/gauge
./gradlew copyGaugeDependencies

# 4. Try again
gauge run specs
```

### Different error: "cannot find or load main class"?

```bash
# Recompile test classes
./gradlew cleanTest testClasses

# Check classes exist
ls -la build/classes/java/test/com/deryncullen/resume/specs/
```

### Gradle task fails?

```bash
# Clean everything
./gradlew clean

# Rebuild with dependencies
./gradlew build copyGaugeDependencies

# Try Gauge
./gradlew gaugeTest
```

## Performance Note

Copying 150 JARs takes a few seconds. The `gaugeTest` task automatically does this, so you don't need to run `copyGaugeDependencies` manually.

## Why Not Use Gradle's Cache?

You might wonder why we copy JARs instead of pointing to `~/.gradle/caches/`. 

Reasons:
1. **Simpler**: Clear, predictable location
2. **Reliable**: Doesn't depend on Gradle's internal cache structure
3. **Portable**: Works across different machines
4. **Explicit**: Easy to see what Gauge is using

## .gitignore

Add this to your `.gitignore`:

```
# Gauge dependencies (regenerated by Gradle)
libs/gauge/
```

These are just copies of your Gradle dependencies, so no need to commit them.

## CI/CD

In your CI/CD pipeline:

```bash
# GitHub Actions / Jenkins / etc.
./gradlew clean build copyGaugeDependencies test gaugeTest
```

The `gaugeTest` task handles the dependency copy automatically.

## Summary

**Problem**: Gauge couldn't find Spring Boot JAR files
**Solution**: Copy all Gradle dependencies to `libs/gauge/`
**How**: New Gradle task + updated java.properties
**Result**: All Gauge tests pass! ğŸ‰

Run the fix script and you're done!
